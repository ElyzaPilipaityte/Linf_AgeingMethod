---
title: "Untitled"
author: "Elyza Pilipaityte"
date: "2024-07-08"
output: html_document
---

```{r}
rm(list=ls())
```

Libraries
```{r}
library(tidyverse)
library(lme4)
library(sjPlot)
library(rfishbase)
library(car)

My_theme <- theme(
  panel.background = element_blank(),
  panel.border = element_rect(fill = NA, linewidth = 1),
  strip.background = element_rect(fill = "white", color = "white", linewidth = 1.25),
  text = element_text(size = 16, family = "gillsans"),
  panel.grid.major = element_blank(),  # Remove major grid lines
  panel.grid.minor = element_blank()   # Remove minor grid lines
)
```

# popgrowth tables

```{r}
# getting species names from fishbase
fish <- species_names()
species_list <- fish$Species
# extracting available growth data for all species
spp_data <- popgrowth(species_list)
# number of species
length(unique(spp_data$Species))

# selecting only necessary variables and excluding doubtful estimates
data <- spp_data %>% select(Species, method = Data, TLinfinity, K, Auxim, Sex, Type, Loo, to) %>% filter(Auxim != "doubtful")

# any missing aging method
colSums(is.na(data))
# removing missing aging method
data <- data %>% drop_na(method)

# aging methods
table(data$method)
# renaming aging methods
data$method <- ifelse(data$method %in% c("annuli on few otoliths", "annuli on many otoliths", "annuli on otoliths", "daily otolith rings", "otoliths"), "otoliths",
ifelse(data$method %in% c("others", "several data types", "other annual rings", "various data types"), "others",
ifelse(data$method %in% c("scale annual rings", "scales", "scale"), "scales",
ifelse(data$method %in% c("Lmax Lm tm", "Lmax tmax", "length-frequencies"), "growth",
ifelse(data$method %in% c("direct observation", "tagging/recapture"), "direct_observ",
data$method)))))

# filtering only scale or otolith method
data <- data %>% filter(method == "scales" | method == "otoliths")
length(unique(data$Species))

# Filter species that have both "scales" and "otoliths" aging methods
species_with_both_methods <- data %>%
  group_by(Species) %>%
  summarise(has_scales = "scales" %in% method,
            has_otoliths = "otoliths" %in% method) %>%
  filter(has_scales & has_otoliths) %>%
  pull(Species)

# Filter the original data to include only species with both methods and exclude doubtful estimations of Linf
data_filtered <- data %>% filter(Species %in% species_with_both_methods) %>% filter(method == "otoliths" | method == "scales")

```

Table to see how many observations in each method for different species

```{r}
# Group by species and method, then count the number of observations
method_counts <- data_filtered %>%
  group_by(Species, method) %>%
  summarise(count = n(), .groups = 'drop')

# Create a table with species names as rows and methods as columns
method_counts_table <- method_counts %>%
  pivot_wider(names_from = method, values_from = count, values_fill = 0)
```

Many species have only one estimation for one of the methods, I filter the species which have more than 4 estimates using each method.

```{r}
# Filter species that have more than 4 Linf counts using both methods
filtered_species <- data_filtered %>%
  group_by(Species, method) %>%
  summarise(count = n(), .groups = 'drop') %>%
  pivot_wider(names_from = method, values_from = count, values_fill = 0) %>%
  filter(scales > 4 & otoliths > 4) %>%
  pull(Species)

# Further filter the original data to include only species meeting the criteria
data_filtered_final <- data_filtered %>%
  filter(Species %in% filtered_species)

table(data_filtered_final$Species)
```

# load data with year
year included in the csv file from FishBase references manually

```{r}
data <- read_csv(file = "rfish_Linf_year.csv")
```

Let's look at the data 

```{r}
str(data)

ggplot(data, aes(x = year, y = method, fill = method)) +
  geom_boxplot() +
  xlab("year") +
  ylab("method") +
  My_theme

# I exclude estimate made a long time ago compared to the others
data <- data %>% filter(year > 1925)

ggplot(data, aes(x = year, y = method, fill = method)) +
  geom_boxplot() +
  xlab("year") +
  ylab("method") +
  My_theme

# Number of estimations per year and method
ggplot(data, aes(x = year, fill = method)) +
  geom_bar(position = "dodge") +
  xlab("Year") +
  ylab("Count") +
  scale_x_continuous(breaks = seq(min(data$year), max(data$year), by = 10)) +
 My_theme

data_summary <- data %>%
  group_by(year, method) %>%
  summarise(Frequency = n())

ggplot(data_summary, aes(x = year, y = Frequency, color = method)) +
  geom_point(size = 3, position = position_dodge(width = 0.2)) +
  geom_smooth(method = "lm", se = FALSE, size = 1.5) +
  xlab("Year") + ylab("Frequency of Linf Observations") +
  My_theme + 
geom_smooth(method = "lm", se = TRUE, size = 1.5)

# It does not show the differences between methods used in different years

table(data$year)
table(data$Locality)
table(data$Sex)
table(data$Species)
table(data$method)
table(data$Species, data$method)

ggplot(data, aes(x = as.factor(year), y = Loo, color = method)) +
  geom_jitter(size = 2) +
  facet_wrap(~ Species) +
  scale_x_discrete(breaks = unique(data$year)[seq(1, length(unique(data$year)), by = 10)]) +
  labs(
    x = "Year",
    y = expression(L[infinity]~"(cm)"),
    color = "Method"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  My_theme

```

Plot showing Linf differences between species and methods

```{r}
ggplot(data, aes(x = Species, y = Loo, fill = method)) +
  # Boxplots: semi-transparent
  geom_boxplot(alpha = 0.4, position = position_dodge(width = 0.75)) +
  # Dots: fully opaque (no alpha)
  geom_jitter(
    aes(color = method),
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
    size = 1.8
  ) +
  scale_fill_manual(values = c("scales" = "#D55E00", "otoliths" = "#332288")) +
  scale_color_manual(values = c("scales" = "#D55E00", "otoliths" = "#332288")) +
  theme_minimal() +
  xlab("Species") +
  ylab(expression(L[infinity]~"(cm)")) +
  theme(
    panel.background = element_rect(fill = "white"), 
    axis.text = element_text(size = 14), 
    axis.title = element_text(size = 16), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 55, hjust = 1),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )

```

Data exploration 

1. Outliers in response and independent variables

```{r}
ggplot(data = data) + 
  geom_point(mapping = aes(x = Loo, y = Species, color=as.factor(method)), position = "jitter", size = 2.5)
# no outliers
```

2. Normality and homogeneity of the response variable

```{r}
# Frequency plot
hist(data$Loo,  xlab = "Length (cm)",
     col = "lightblue", border = "black", main = "")
```

3. Balance of categorical variables

```{r}
table(data$Species)
table(data$method)
table(data$year)
```
The data is balanced across methods and species. However, for each year, there are only one or a few observations, so I cannot include year in the model. Previous plots also showed no clear temporal trend in the use of scales and otoliths, despite our initial assumption that scales were used in earlier years and otoliths in more recent years.

4. Multicollinearity among covariates

```{r}
#Calculate Variance Inflation Factor (VIF)
round(vif(lm(Loo ~ method + Species + K,
                     data = data)),2)

round(vif(lm(K ~ method + Species + Loo,
                     data = data)),2)
# There is moderate collinearity between Linf and the other predictors because Linf is species specific
cor(data$Loo, data$K)
```

5. Relationships among response and independent variables

```{r}
# Interaction? Plot data
ggplot(data, aes(x = year, y = (Loo), color = Species)) +
  geom_point(shape = 16, size = 2, alpha = 0.7, position = "jitter") +
  geom_smooth(method = 'lm', colour = 'red', se = FALSE, size = 1.5) +
  xlab("method") + ylab("Linf (cm)") +
  facet_wrap(~method)

ggplot(data, aes(x = year, y = (Linf_stand), color = Species)) +
  geom_point(shape = 16, size = 2, alpha = 0.7, position = "jitter") +
  geom_smooth(method = 'lm', colour = 'red', se = FALSE, size = 1.5) +
  xlab("method") + ylab("Linf (cm)") +
  facet_wrap(~method)

ggplot(data, aes(x = method, y = (Loo), color = Species)) +
  geom_point(shape = 16, size = 2, alpha = 0.7, position = "jitter") +
  geom_smooth(method = 'lm', colour = 'red', se = FALSE, size = 1.5) +
  xlab("method") + ylab("Linf (cm)")

ggplot(data, aes(x = method, y = (Linf_stand), color = Species)) +
  geom_point(shape = 16, size = 2, alpha = 0.7, position = "jitter") +
  geom_smooth(method = 'lm', colour = 'red', se = FALSE, size = 1.5) +
  xlab("method") + ylab("Linf (cm)")
```


# Linf Models

```{r}
# Z transformation
data$Linf_z <- scale(data$Loo)
data$K_z <- scale(data$K)

m1 <- lmer(Loo ~ method + (1|Species), data = data, REML = F)
# Linf transformed
m2 <- lmer(Linf_z ~ method + (1|Species), data = data, REML = F)
# K trannsformed included as fixed effect
m3 <- lmer(Loo ~ method + K_z + (1|Species), data = data, REML = F)
# K trannsformed included as random effect
m4 <- lmer(Loo ~ method + (1|Species) + (1|K_z), data = data, REML = F)

anova(m1, m3)
anova(m2, m4)

```



```{r}
# Summarise neatly in a table
tab_model(m4,
          show.zeroinf = F,
           string.pred = "Coefficient",
             string.ci = "Conf. Int (95%)",
              string.p = "P-value",
               p.style = c("numeric"),
                emph.p = FALSE,
             transform = NULL)

```

Residuals

```{r}
# 1. Linearity & Homoscedasticity: Residuals vs Fitted plot
resid <- resid(m4)
fitted <- fitted(m4)

plot(fitted, resid,
     xlab = "Fitted values",
     ylab = "Residuals",
     cex.lab = 1.3,
     cex.axis = 1.2
)
abline(h = 0, col = "red")

# 2. Normality of residuals: Q-Q plot of residuals
qqnorm(resid(m4))
qqline(resid(m4))

# 3. Normality of random effects: Q-Q plot for random effect
qqnorm(ranef(m4)$K_z[,1])
qqline(ranef(m4)$K_z[,1])

# 4. Variance of random effects (Species)
summary(m4)$varcor

# 5. Histogram of Residuals
hist((residuals(m4)), breaks = 30, main = " ")
```

```{r}
library(patchwork)

# 1. Residuals vs Fitted
resid <- resid(m4)
fitted <- fitted(m4)
res_df <- data.frame(Fitted = fitted, Residuals = resid)

p1 <- ggplot(res_df, aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Residuals vs Fitted",
       x = "Fitted values", y = "Residuals") +
  My_theme

# 2. QQ Plot of Residuals
p2 <- ggplot(res_df, aes(sample = Residuals)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "QQ Plot of Residuals",
       x = "Theoretical", y = "Sample")  +
  My_theme

# 3. QQ Plot of Random Effects
ranef_vals <- ranef(m4)$Species[,1]
ranef_df <- data.frame(ranef = ranef_vals)

p3 <- ggplot(ranef_df, aes(sample = ranef)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "QQ Plot of Random Effects",
       x = "Theoretical", y = "Random Intercepts")  +
  My_theme

# 4. Histogram of Residuals
p4 <- ggplot(res_df, aes(x = Residuals)) +
  geom_histogram(bins = 32, fill = "gray70", color = "black") +
  labs(title = "Histogram of Residuals",
       x = "Residuals", y = "Count")  +
  My_theme

final_plot <- gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
```

Save
```{r}
library(grid)
tiff("modelFit_Linf.tiff", width = 300, height = 250, units = "mm", res = 300, compression = "lzw")
grid.draw(final_plot)
dev.off()
```


# K Model

Data exploration 

1. Outliers in response and independent variables

```{r}
ggplot(data = data) + 
  geom_point(mapping = aes(x = K, y = Species, color=as.factor(method)), size = 2.5)
# no outliers

```

2. Normality and homogeneity of the response variable

```{r}
# Frequency plot

hist(data$K_trans,  xlab = "Length (cm)",
     col = "lightblue", border = "black", main = "")

```

```{r}
data$K_trans <- sqrt(data$K)
# data$K_trans <- log(data$K)

```

3. Balance of categorical variables

```{r}
table(data$Species)
table(data$method)
table(data$year)
```

4. Multicollinearity among covariates

```{r}
#Calculate Variance Inflation Factor (VIF)
round(vif(lm(K ~ method + Species + Loo,
                     data = data)),2)

round(vif(lm(K_trans ~ method + Species + Linf_z,
                     data = data)),2)
```
I cannot use species and Linf as explanatory variables in the same model because they can cause multicollinearity issues.

5. Relationships among response and independent variables

```{r}
# Interaction? Plot data
ggplot(data, aes(x = year, y = (K), color = Species)) +
  geom_point(shape = 16, size = 2, alpha = 0.7, position = "jitter") +
  geom_smooth(method = 'lm', colour = 'red', se = FALSE, size = 1.5) +
  xlab("method") + ylab("K (cm)") +
  facet_wrap(~method)

ggplot(data, aes(x = year, y = (K_trans), color = Species)) +
  geom_point(shape = 16, size = 2, alpha = 0.7, position = "jitter") +
  geom_smooth(method = 'lm', colour = 'red', se = FALSE, size = 1.5) +
  xlab("method") + ylab("K (cm)") +
  facet_wrap(~method)

```


```{r}
m0 <- lm(K ~ method, data = data)
m1 <- lmer(K ~ method + (1|Species), data = data, REML = F)
m2 <- lmer(K_z ~ method + (1|Linf_z), data = data, REML = F)
m3 <- lmer(K ~ method + (1|Loo), data = data, REML = F)
m4 <- lmer(K_trans ~ method + (1|Loo), data = data, REML = F)

```


```{r}
# Summarise neatly in a table
tab_model(m4,
          show.zeroinf = F,
           string.pred = "Coefficient",
             string.ci = "Conf. Int (95%)",
              string.p = "P-value",
               p.style = c("numeric"),
                emph.p = FALSE,
             transform = NULL)

```

Residuals

```{r}
# 1. Linearity & Homoscedasticity: Residuals vs Fitted plot
plot(m4)

# 2. Normality of residuals: Q-Q plot of residuals
qqnorm(residuals(m4))
qqline(residuals(m4))

# 3. Normality of random effects: Q-Q plot for random effects
qqnorm(ranef(m4)$Linf_z[,1])
qqline(ranef(m4)$Linf_z[,1])

# 4. Variance of random effects (Species)
summary(m4)$varcor

hist((residuals(m4)), breaks = 30, main = "Histogram of Residuals")
```

```{r}
library(patchwork)

# 1. Residuals vs Fitted
resid <- resid(m4)
fitted <- fitted(m4)
res_df <- data.frame(Fitted = fitted, Residuals = resid)

p1 <- ggplot(res_df, aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Residuals vs Fitted",
       x = "Fitted values", y = "Residuals") +
  My_theme

# 2. QQ Plot of Residuals
p2 <- ggplot(res_df, aes(sample = Residuals)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "QQ Plot of Residuals",
       x = "Theoretical", y = "Sample")  +
  My_theme

# 3. QQ Plot of Random Effects
ranef_vals <- ranef(m4)$Loo[,1]
ranef_df <- data.frame(ranef = ranef_vals)

p3 <- ggplot(ranef_df, aes(sample = ranef)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "QQ Plot of Random Effects",
       x = "Theoretical", y = "Random Intercepts")  +
  My_theme

# 4. Histogram of Residuals
p4 <- ggplot(res_df, aes(x = Residuals)) +
  geom_histogram(bins = 32, fill = "gray70", color = "black") +
  labs(title = "Histogram of Residuals",
       x = "Residuals", y = "Count")  +
  My_theme

final_plot <- gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
```

Save
```{r}
library(grid)
tiff("modelFit_K.tiff", width = 300, height = 250, units = "mm", res = 300, compression = "lzw")
grid.draw(final_plot)
dev.off()
```



