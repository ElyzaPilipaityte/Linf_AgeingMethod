---
title: "vonB_CL"
author: "Elyza Pilipaityte"
date: "2024-10-21"
output: html_document
---

```{r}

rm(list=ls())

```


```{r}
library(tidyverse)
library(FSA)
theme_set(theme_bw())
library(investr)
library(car)
library(BayesGrowth)
library(rstan)
```


## Perch

Uploading data

```{r}
data2023 <- read_csv(file = "2023.csv")

perch23otoliths <- data2023 %>% filter (spp_name_lt=="Eserys") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age)

perch23otoliths <- perch23otoliths %>% mutate(method = "otoliths")

perch23scales <- data2023 %>% filter (spp_name_lt=="Eserys") %>% select(tl = total_length, age = age_scales, sex_en) %>% drop_na(age) %>% mutate(method = "scales")

perch <- rbind(perch23otoliths, perch23scales)

perch$method <- as.factor(perch$method)
```

```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(perch$method)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- perch |>              ## Range of observed ages by group
  group_by(method) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=perch) ## Starting values ignoring groups
```

```{r}
( svLKt <- data.frame(method=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```

```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,method==grp)
  sv1 <- svs |>
    filter(method==grp) |>
    select(-method) |>
    as.list()
  oagerng1 <- filter(oagerng,method==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(method=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("method","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```


```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, perch, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nMethod:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot1 <- ggplot() +
  geom_ribbon(data=preds, aes(x=age, ymin=lwr, ymax=upr, fill=method), alpha=0.25) +
  geom_point(data=perch, aes(x=age, y=tl, color=method), size=2, alpha=0.3) +
  geom_line(data=preds, aes(x=age, y=fit, color=method), linewidth=1, linetype="dashed") +
  geom_line(data=filter(preds, inrng), aes(x=age, y=fit, color=method), linewidth=1) +
  scale_y_continuous(name="Total Length (mm)", limits=c(0, 60)) +
  scale_x_continuous(name="Age (years)", breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'), aesthetics=c("color", "fill")) +
  scale_y_continuous(name=element_blank(), limits=c(0, 70), expand=c(0, 0)) +
  scale_x_continuous(name=element_blank(), expand=c(0, 0), limits=c(0, 20), breaks=seq(5, 15, 5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position=c(0.8, 0.2),
        axis.title=element_text(size=16),
        axis.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15)) +

  # Add annotations for Linf and K for the first method with standard errors
  annotate("text", x=1, y=65, 
           label=paste0("\nLinf = ", 
                        round(params_list[[1]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[1]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["K", "Std. Error"], 2), ")"), 
           color='#404040', size=5, hjust=0) +

  # Add annotations for Linf and K for the second method with standard errors
  annotate("text", x=1, y=55, 
           label=paste0("\nLinf = ", 
                        round(params_list[[2]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[2]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["K", "Std. Error"], 2), ")"), 
           color='#93003a', size=5, hjust=0)

# Print the plot
print(vbFitPlot1)


```


## Pikeperch

```{r}

sander23otoliths <- data2023 %>% filter (spp_name_lt=="Starkis") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age)

sander23otoliths <- sander23otoliths %>% mutate(method = "otoliths")

sander23scales <- data2023 %>% filter (spp_name_lt=="Starkis") %>% select(tl = total_length, age = age_scales, sex_en) %>% drop_na(age) %>% mutate(method = "scales")

sander <- rbind(sander23otoliths, sander23scales)
```


```{r}
vb <- vbFuns()
predict2 <- function(x) predict(x,data.frame(age=ages))

agesum <- group_by(sander, method) %>%
  summarize(minage=min(age),maxage=max(age))
agesum

sander$method <- as.factor(sander$method)
( methods <- levels(sander$method) )
( nmethods <- length(methods) )
cfs <- cis <- preds1 <- preds2 <- NULL
```

```{r}
for (i in 1:nmethods) {
  ## Loop notification (for peace of mind)
  cat(methods[i],"Loop\n")
  tmp1 <- filter(sander,method==methods[i])
  ## Fit von B to that methods
  sv1 <- vbStarts(tl~age,data=tmp1)
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=tmp1,start=sv1)
  ## Extract and store parameter estimates and CIs
  cfs <- rbind(cfs,coef(fit1))
  boot1 <- Boot(fit1)
  tmp2 <-  confint(boot1)
  cis <- rbind(cis,c(tmp2["Linf",],tmp2["K",],tmp2["t0",]))
  ## Predict mean lengths-at-age with CIs
  ##   preds1 -> across all ages
  ##   preds2 -> across observed ages only
  ages <- seq(-1,30,0.2)
  boot2 <- Boot(fit1,f=predict2)
  tmp2 <- data.frame(method=methods[i],age=ages,
                     predict(fit1,data.frame(age=ages)),
                     confint(boot2))
  preds1 <- rbind(preds1,tmp2)
  tmp2 <- filter(tmp2,age>=agesum$minage[i],age<=agesum$maxage[i])
  preds2 <- rbind(preds2,tmp2)
}
```

```{r}
rownames(cfs) <- rownames(cis) <- methods
colnames(cis) <- paste(rep(c("Linf","K","t0"),each=2),
                       rep(c("LCI","UCI"),times=2),sep=".")
colnames(preds1) <- colnames(preds2) <- c("method","age","fit","LCI","UCI")

vbFitPlot2 <- ggplot() + 
  geom_ribbon(data=preds2,aes(x=age,ymin=LCI,ymax=UCI,fill=method),alpha=0.2) +
  geom_point(data=sander,aes(y=tl,x=age,color=method),alpha=0.25,size=2,
             position=position_dodge(width=0.2)) +
  geom_line(data=preds1,aes(y=fit,x=age,color=method),size=1,linetype=2) +
  geom_line(data=preds2,aes(y=fit,x=age,color=method),size=1) +
  scale_color_manual(values=c('#404040', '#93003a'),
                     aesthetics=c("fill","color")) +
  scale_y_continuous(name=element_blank(),limits=c(0,70),expand=c(0,0)) +
  scale_x_continuous(name=element_blank(),expand=c(0,0),
                     limits=c(0,11),breaks=seq(2,10,2)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
    legend.position = "none",
    axis.title = element_text(size = 16),     # Adjust size of axis titles
    axis.text = element_text(size = 15),      # Adjust size of axis values
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 15)
  ) # +
  # annotate("text", x = 9, y = 55, label = "Linf = -435.33\nK = -0.02", color = '#404040', size = 5, hjust = 0) +
  # annotate("text", x = 9, y = 40, label = "Linf = -185.47\nK = -0.03", color = '#93003a', size = 5, hjust = 0)

vbFitPlot2
```

```{r}
p.K <- ggplot() +
  geom_point(data = cfs, aes(x = methods, y = K), size = 2.5, position = position_dodge(width = 0.2)) +
  geom_errorbar(data = cis, aes(x = methods, ymin = K.LCI, ymax = K.UCI), size = 1, width = 0.1) +
  scale_y_continuous(name = (name="K")) +
  scale_x_discrete(name = "Method", breaks = methods) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 16),
        axis.text = element_text(vjust = 0.5, size = 15),
        legend.text = element_text(size = 15)) +  # Increase text size of legend labels
  guides(color = guide_legend(title = NULL))  # Remove legend title only

p.K

```

```{r}
p.K <- ggplot() +
  geom_point(data = cfs, aes(x = methods, y = Linf), size = 2.5, position = position_dodge(width = 0.2)) +
  geom_errorbar(data = cis, aes(x = methods, ymin = Linf.LCI, ymax = Linf.UCI), size = 1, width = 0.1) +
  scale_y_continuous(name = (name="Linf")) +
  scale_x_discrete(name = "Method", breaks = methods) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 16),
        axis.text = element_text(vjust = 0.5, size = 15),
        legend.text = element_text(size = 15)) +  # Increase text size of legend labels
  guides(color = guide_legend(title = NULL))  # Remove legend title only

p.K

```

## Bream

```{r}
bream23otoliths <- data2023 %>% filter (spp_name_lt=="Karsis") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age)

bream23otoliths <- bream23otoliths %>% mutate(method = "otoliths")

bream23scales <- data2023 %>% filter (spp_name_lt=="Karsis") %>% select(tl = total_length, age = age_scales, sex_en) %>% drop_na(age) %>% mutate(method = "scales")

bream <- rbind(bream23otoliths, bream23scales)

```

```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(bream$method)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- bream |>              ## Range of observed ages by group
  group_by(method) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=bream) ## Starting values ignoring groups
```

```{r}
( svLKt <- data.frame(method=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```


```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,method==grp)
  sv1 <- svs |>
    filter(method==grp) |>
    select(-method) |>
    as.list()
  oagerng1 <- filter(oagerng,method==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(method=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("method","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```

```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, bream, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nMethod:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot3 <- ggplot() +
  geom_ribbon(data=preds, aes(x=age, ymin=lwr, ymax=upr, fill=method), alpha=0.25) +
  geom_point(data=bream, aes(x=age, y=tl, color=method), size=2, alpha=0.3) +
  geom_line(data=preds, aes(x=age, y=fit, color=method), linewidth=1, linetype="dashed") +
  geom_line(data=filter(preds, inrng), aes(x=age, y=fit, color=method), linewidth=1) +
  scale_y_continuous(name="Total Length (mm)", limits=c(0, 60)) +
  scale_x_continuous(name="Age (years)", breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'), aesthetics=c("color", "fill")) +
  scale_y_continuous(name=element_blank(), limits=c(0, 70), expand=c(0, 0)) +
  scale_x_continuous(name=element_blank(), expand=c(0, 0), limits=c(0, 20), breaks=seq(5, 15, 5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position="none",
        axis.title=element_text(size=16),
        axis.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15)) +

  # Add annotations for Linf and K for the first method with standard errors
  annotate("text", x=1, y=65, 
           label=paste0("\nLinf = ", 
                        format(round(params_list[[1]]["Linf", "Estimate"], 2), nsmall = 2), 
                        " (SE ± ", format(round(params_list[[1]]["Linf", "Std. Error"], 2), nsmall = 2), ")\n",
                        "K = ", format(round(params_list[[1]]["K", "Estimate"], 2), nsmall = 2), 
                        " (SE ± ", format(round(params_list[[1]]["K", "Std. Error"], 2), nsmall = 2), ")"), 
           color='#404040', size=5, hjust=0) +

  # Add annotations for Linf and K for the second method with standard errors
  annotate("text", x=1, y=55, 
           label=paste0("\nLinf = ", 
                        format(round(params_list[[2]]["Linf", "Estimate"], 2), nsmall = 2), 
                        " (SE ± ", format(round(params_list[[2]]["Linf", "Std. Error"], 2), nsmall = 2), ")\n",
                        "K = ", format(round(params_list[[2]]["K", "Estimate"], 2), nsmall = 2), 
                        " (SE ± ", format(round(params_list[[2]]["K", "Std. Error"], 2), nsmall = 2), ")"), 
           color='#93003a', size=5, hjust=0)

# Print the plot
print(vbFitPlot3)

```

# Roach

```{r}
roach1 <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(tl = total_length, age_ot = age_Egle, age_sc = age_scales, sex_en)

roach23otoliths <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age)

roach23otoliths <- roach23otoliths %>% mutate(method = "otoliths")

roach23scales <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(tl = total_length, age = age_scales, sex_en) %>% drop_na(age) %>% mutate(method = "scales")

roach <- rbind(roach23otoliths, roach23scales)
```

```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(roach$method)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- roach |>              ## Range of observed ages by group
  group_by(method) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=roach) ## Starting values ignoring groups
```

```{r}
( svLKt <- data.frame(method=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```


```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,method==grp)
  sv1 <- svs |>
    filter(method==grp) |>
    select(-method) |>
    as.list()
  oagerng1 <- filter(oagerng,method==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(method=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("method","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```

```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, roach, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nMethod:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot4 <- ggplot() +
  geom_ribbon(data=preds,aes(x=age,ymin=lwr,ymax=upr,fill=method),alpha=0.25) +
  geom_point(data=roach,aes(x=age,y=tl,color=method),
             size=2,alpha=0.3) +
  geom_line(data=preds,aes(x=age,y=fit,color=method),
              linewidth=1,linetype="dashed") +
  geom_line(data=filter(preds,inrng),aes(x=age,y=fit,color=method),
              linewidth=1) +
  scale_y_continuous(name="Total Length (mm)",limits=c(0,60)) +
  scale_x_continuous(name="Age (years)",breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'),
                     aesthetics=c("color","fill")) +
  scale_y_continuous(name = element_blank(),limits=c(0,70),expand=c(0,0)) +
  scale_x_continuous(name = element_blank(),expand=c(0,0),
                     limits=c(0,20),breaks=seq(5,15,5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position = "none",
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15)) +

  # Add annotations for Linf and K for the first method
  annotate("text", x=1, y=65, label=paste0("\nLinf = ", 
                                            format(round(params_list[[1]]["Linf", "Estimate"], 2), nsmall = 2),
                                           " (SE ± ", format(round(params_list[[1]]["Linf", "Std. Error"], 2), nsmall = 2), ")\n",
                                            "K = ", format(round(params_list[[1]]["K", "Estimate"], 2), nsmall = 2),
           " (SE ± ", format(round(params_list[[1]]["K", "Std. Error"], 2), nsmall = 2), ")"), 
           color='#404040', size=5, hjust=0)

```

# One plot

```{r}
library(gridExtra)
library(grid)

# Species names
species_names <- c("a, Perca fluviatilis", "b, Sander lucioperca", "c, Abramis brama", "d, Rutilus rutilus")

# Arrange the plots with titles
combined_plot <- grid.arrange(
  arrangeGrob(textGrob(species_names[1], gp = gpar(fontsize = 17, fontface = "italic")), vbFitPlot1, ncol = 1, heights = c(0.1, 1)),
  arrangeGrob(textGrob(species_names[2], gp = gpar(fontsize = 17, fontface = "italic")), vbFitPlot2, ncol = 1, heights = c(0.1, 1)),
  arrangeGrob(textGrob(species_names[3], gp = gpar(fontsize = 17, fontface = "italic")), vbFitPlot3, ncol = 1, heights = c(0.1, 1)),
  arrangeGrob(textGrob(species_names[4], gp = gpar(fontsize = 17, fontface = "italic")), vbFitPlot4, ncol = 1, heights = c(0.1, 1)),
  ncol = 2, nrow = 2
)

# Add common axis labels
grid.arrange(combined_plot,
             bottom = textGrob("Age (years)", gp = gpar(fontsize = 16)),
             left = textGrob("Total length (cm)", rot = 90, gp = gpar(fontsize = 16))
)

```

```{r}
ggsave("vonB.tiff", plot = combined_plot, units = "mm", 
       width = 300, height = 250, dpi = 300, compression = 'lzw')
```

```{r}
# Create a TIFF file with specific resolution and dimensions
svg("combined_plot.svg", width = 12, height = 10)

# Draw the combined plot with common axis labels
grid.arrange(combined_plot,
             bottom = textGrob("Age (years)", gp = gpar(fontsize = 16)),
             left = textGrob("Total Length (cm)", rot = 90, gp = gpar(fontsize = 16)))

# Close the TIFF device
dev.off()
```

####################
# Differences between readers

## Perch
```{r}
data2023 <- read_csv(file = "2023.csv")

perch23otoliths1 <- data2023 %>% filter (spp_name_lt=="Eserys") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age) %>% mutate(reader = "1")

perch23otoliths2 <- data2023 %>% filter (spp_name_lt=="Eserys") %>% select(tl = total_length, age = age_Elyza, sex_en) %>% drop_na(age) %>% mutate(reader = "2")

perch <- rbind(perch23otoliths1, perch23otoliths2)

perch$reader <- as.factor(perch$reader)
perch$age <- as.numeric(perch$age)
```

```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(perch$reader)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- perch |>              ## Range of observed ages by group
  group_by(reader) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=perch) ## Starting values ignoring groups

```

```{r}
( svLKt <- data.frame(reader=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```

```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,reader==grp)
  sv1 <- svs |>
    filter(reader==grp) |>
    select(-reader) |>
    as.list()
  oagerng1 <- filter(oagerng,reader==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(reader=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("reader","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```


```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, perch, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nReader:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot1 <- ggplot() +
  geom_ribbon(data=preds, aes(x=age, ymin=lwr, ymax=upr, fill=reader), alpha=0.25) +
  geom_point(data=perch, aes(x=age, y=tl, color=reader), size=2, alpha=0.3) +
  geom_line(data=preds, aes(x=age, y=fit, color=reader), linewidth=1, linetype="dashed") +
  geom_line(data=filter(preds, inrng), aes(x=age, y=fit, color=reader), linewidth=1) +
  scale_y_continuous(name="Total Length (mm)", limits=c(0, 60)) +
  scale_x_continuous(name="Age (years)", breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'), aesthetics=c("color", "fill")) +
  scale_y_continuous(name=element_blank(), limits=c(0, 70), expand=c(0, 0)) +
  scale_x_continuous(name=element_blank(), expand=c(0, 0), limits=c(0, 20), breaks=seq(5, 15, 5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position=c(0.8, 0.2),
        axis.title=element_text(size=16),
        axis.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15)) +

  # Add annotations for Linf and K for the first method with standard errors
  annotate("text", x=1, y=65, 
           label=paste0("\nLinf = ", 
                        round(params_list[[1]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[1]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["K", "Std. Error"], 2), ")"), 
           color='#404040', size=5, hjust=0) +

  # Add annotations for Linf and K for the second method with standard errors
  annotate("text", x=1, y=55, 
           label=paste0("\nLinf = ", 
                        round(params_list[[2]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[2]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["K", "Std. Error"], 2), ")"), 
           color='#93003a', size=5, hjust=0)

# Print the plot
print(vbFitPlot1)

```

## Pikeperch
```{r}
data2023 <- read_csv(file = "2023.csv")

perch23otoliths1 <- data2023 %>% filter (spp_name_lt=="Starkis") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age) %>% mutate(reader = "1")

perch23otoliths2 <- data2023 %>% filter (spp_name_lt=="Starkis") %>% select(tl = total_length, age = age_Elyza, sex_en) %>% drop_na(age) %>% mutate(reader = "2")

perch <- rbind(perch23otoliths1, perch23otoliths2)

perch$reader <- as.factor(perch$reader)
perch$age <- as.numeric(perch$age)
```

```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(perch$reader)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- perch |>              ## Range of observed ages by group
  group_by(reader) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=perch) ## Starting values ignoring groups

```

```{r}
( svLKt <- data.frame(reader=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```

```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,reader==grp)
  sv1 <- svs |>
    filter(reader==grp) |>
    select(-reader) |>
    as.list()
  oagerng1 <- filter(oagerng,reader==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(reader=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("reader","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```


```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, perch, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nReader:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot1 <- ggplot() +
  geom_ribbon(data=preds, aes(x=age, ymin=lwr, ymax=upr, fill=reader), alpha=0.25) +
  geom_point(data=perch, aes(x=age, y=tl, color=reader), size=2, alpha=0.3) +
  geom_line(data=preds, aes(x=age, y=fit, color=reader), linewidth=1, linetype="dashed") +
  geom_line(data=filter(preds, inrng), aes(x=age, y=fit, color=reader), linewidth=1) +
  scale_y_continuous(name="Total Length (mm)", limits=c(0, 60)) +
  scale_x_continuous(name="Age (years)", breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'), aesthetics=c("color", "fill")) +
  scale_y_continuous(name=element_blank(), limits=c(0, 70), expand=c(0, 0)) +
  scale_x_continuous(name=element_blank(), expand=c(0, 0), limits=c(0, 20), breaks=seq(5, 15, 5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position=c(0.8, 0.2),
        axis.title=element_text(size=16),
        axis.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15)) +

  # Add annotations for Linf and K for the first method with standard errors
  annotate("text", x=1, y=65, 
           label=paste0("\nLinf = ", 
                        round(params_list[[1]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[1]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["K", "Std. Error"], 2), ")"), 
           color='#404040', size=5, hjust=0) +

  # Add annotations for Linf and K for the second method with standard errors
  annotate("text", x=1, y=55, 
           label=paste0("\nLinf = ", 
                        round(params_list[[2]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[2]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["K", "Std. Error"], 2), ")"), 
           color='#93003a', size=5, hjust=0)

# Print the plot
print(vbFitPlot1)

```

## Roach
```{r}
data2023 <- read_csv(file = "2023.csv")

perch23otoliths1 <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age) %>% mutate(reader = "1")

perch23otoliths2 <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(tl = total_length, age = age_Elyza, sex_en) %>% drop_na(age) %>% mutate(reader = "2")

perch <- rbind(perch23otoliths1, perch23otoliths2)

perch$reader <- as.factor(perch$reader)
perch$age <- as.numeric(perch$age)
```

```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(perch$reader)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- perch |>              ## Range of observed ages by group
  group_by(reader) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=perch) ## Starting values ignoring groups

```

```{r}
( svLKt <- data.frame(reader=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```

```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,reader==grp)
  sv1 <- svs |>
    filter(reader==grp) |>
    select(-reader) |>
    as.list()
  oagerng1 <- filter(oagerng,reader==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(reader=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("reader","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```


```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, perch, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nReader:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot1 <- ggplot() +
  geom_ribbon(data=preds, aes(x=age, ymin=lwr, ymax=upr, fill=reader), alpha=0.25) +
  geom_point(data=perch, aes(x=age, y=tl, color=reader), size=2, alpha=0.3) +
  geom_line(data=preds, aes(x=age, y=fit, color=reader), linewidth=1, linetype="dashed") +
  geom_line(data=filter(preds, inrng), aes(x=age, y=fit, color=reader), linewidth=1) +
  scale_y_continuous(name="Total Length (mm)", limits=c(0, 60)) +
  scale_x_continuous(name="Age (years)", breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'), aesthetics=c("color", "fill")) +
  scale_y_continuous(name=element_blank(), limits=c(0, 70), expand=c(0, 0)) +
  scale_x_continuous(name=element_blank(), expand=c(0, 0), limits=c(0, 20), breaks=seq(5, 15, 5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position=c(0.8, 0.2),
        axis.title=element_text(size=16),
        axis.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15)) +

  # Add annotations for Linf and K for the first method with standard errors
  annotate("text", x=1, y=65, 
           label=paste0("\nLinf = ", 
                        round(params_list[[1]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[1]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["K", "Std. Error"], 2), ")"), 
           color='#404040', size=5, hjust=0) +

  # Add annotations for Linf and K for the second method with standard errors
  annotate("text", x=1, y=55, 
           label=paste0("\nLinf = ", 
                        round(params_list[[2]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[2]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["K", "Std. Error"], 2), ")"), 
           color='#93003a', size=5, hjust=0)

# Print the plot
print(vbFitPlot1)

```

## Bream
```{r}
perch23otoliths1 <- data2023 %>% filter (spp_name_lt=="Karsis") %>% select(tl = total_length, age = age_Egle, sex_en) %>% drop_na(age) %>% mutate(reader = "1")

perch23otoliths2 <- data2023 %>% filter (spp_name_lt=="Karsis") %>% select(tl = total_length, age = age_Elyza, sex_en) %>% drop_na(age) %>% mutate(reader = "2")

perch <- rbind(perch23otoliths1, perch23otoliths2)

perch$reader <- as.factor(perch$reader)
perch$age <- as.numeric(perch$age)
```


```{r}
vb <- vbFuns(param="Typical")     ## Typical VBGF
grps <- unique(perch$reader)          ## Names of groups
ngrps <- length(grps)             ## Number of groups
obsagerng <- perch |>              ## Range of observed ages by group
  group_by(reader) |>
  summarize(min=min(age),
            max=max(age))
sv0 <- vbStarts(tl~age,data=perch) ## Starting values ignoring groups

```

```{r}
( svLKt <- data.frame(reader=grps,
                      Map(rep,sv0,c(ngrps,ngrps,ngrps))) )
```

```{r}
vbLOOP1 <- function(grp,dat,svs,oagerng,eagerng,interval="confidence") {
  ## Loop notification (for peace of mind)
  cat(grp, "Loop\n")
  ## Isolate group's data, starting values, and age range
  dat1 <- dplyr::filter(dat,reader==grp)
  sv1 <- svs |>
    filter(reader==grp) |>
    select(-reader) |>
    as.list()
  oagerng1 <- filter(oagerng,reader==grp)
  ## Make ages for predictions
  ages <- seq(min(eagerng),max(eagerng),length.out=101)
  ## Fit von B to that group
  fit1 <- nls(tl~vb(age,Linf,K,t0),data=dat1,start=sv1)
  ## Extract the fitted parameters
  fit_params <- summary(fit1)$coefficients
  
  ## Make data frame of predicted mean lengths at age with CIs
  preds1 <- data.frame(reader=grp,
                       age=ages,
                       fit=investr::predFit(fit1,data.frame(age=ages),
                                            interval=interval)) |>
    mutate(inrng=age>=oagerng1$min & age<=oagerng1$max) |>
    as.data.frame()
  ## Rename variables
  names(preds1) <- c("reader","age","fit","lwr","upr","inrng")
  
  ## Return both predictions and the fitted parameters
  list(preds = preds1, params = fit_params)
}

```


```{r}
preds <- NULL
params_list <- list()

for (i in grps) {
  result <- vbLOOP1(i, perch, svLKt, obsagerng, c(0, 20))
  preds <- rbind(preds, result$preds)
  params_list[[i]] <- result$params  # Store the parameters for each method
}

peek(preds)

for (i in grps) {
  cat("\nReader:", i, "\n")
  cat("Linf:", params_list[[i]]["Linf", "Estimate"], "\n")
  cat("K:", params_list[[i]]["K", "Estimate"], "\n")
}

```

```{r}
vbFitPlot1 <- ggplot() +
  geom_ribbon(data=preds, aes(x=age, ymin=lwr, ymax=upr, fill=reader), alpha=0.25) +
  geom_point(data=perch, aes(x=age, y=tl, color=reader), size=2, alpha=0.3) +
  geom_line(data=preds, aes(x=age, y=fit, color=reader), linewidth=1, linetype="dashed") +
  geom_line(data=filter(preds, inrng), aes(x=age, y=fit, color=reader), linewidth=1) +
  scale_y_continuous(name="Total Length (mm)", limits=c(0, 60)) +
  scale_x_continuous(name="Age (years)", breaks=0:20) +
  scale_color_manual(values=c('#404040', '#93003a'), aesthetics=c("color", "fill")) +
  scale_y_continuous(name=element_blank(), limits=c(0, 70), expand=c(0, 0)) +
  scale_x_continuous(name=element_blank(), expand=c(0, 0), limits=c(0, 20), breaks=seq(5, 15, 5)) +
  theme_bw() +
  theme(panel.grid=element_blank(),
        legend.position=c(0.8, 0.2),
        axis.title=element_text(size=16),
        axis.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15)) +

  # Add annotations for Linf and K for the first method with standard errors
  annotate("text", x=1, y=65, 
           label=paste0("\nLinf = ", 
                        round(params_list[[1]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[1]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[1]]["K", "Std. Error"], 2), ")"), 
           color='#404040', size=5, hjust=0) +

  # Add annotations for Linf and K for the second method with standard errors
  annotate("text", x=1, y=55, 
           label=paste0("\nLinf = ", 
                        round(params_list[[2]]["Linf", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["Linf", "Std. Error"], 2), ")\n",
                        "K = ", round(params_list[[2]]["K", "Estimate"], 2), 
                        " (SE ± ", round(params_list[[2]]["K", "Std. Error"], 2), ")"), 
           color='#93003a', size=5, hjust=0)

# Print the plot
print(vbFitPlot1)

```

# Difference between readers in age estimation
# perch
```{r}
perch23 <- data2023 %>% filter (spp_name_lt=="Eserys") %>% drop_na(age_Egle)

# Count the number of observations for each age pair
count_df <- perch23 %>%
  count(age_Egle, age_Elyza) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_Egle <- as.numeric(as.character(count_df$age_Egle))
count_df$age_Elyza <- as.numeric(as.character(count_df$age_Elyza))

ggplot(count_df, aes(x = age_Egle, y = age_Elyza, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Egle)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()

# Scales
perch23 <- data2023 %>% filter (spp_name_lt=="Eserys") %>% drop_na(age_scales2)

# Count the number of observations for each age pair
count_df <- perch23 %>%
  count(age_scales2, age_scales) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_scales2 <- as.numeric(as.character(count_df$age_scales2))
count_df$age_scales <- as.numeric(as.character(count_df$age_scales))

ggplot(count_df, aes(x = age_scales2, y = age_scales, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Audrius)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()
```

# pikeperch

```{r}
sander23 <- data2023 %>% filter (spp_name_lt=="Starkis") %>% drop_na(age_Egle)

# Count the number of observations for each age pair
count_df <- sander23 %>%
  count(age_Egle, age_Elyza) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_Egle <- as.numeric(as.character(count_df$age_Egle))
count_df$age_Elyza <- as.numeric(as.character(count_df$age_Elyza))

ggplot(count_df, aes(x = age_Egle, y = age_Elyza, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Egle)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()

# Scales
sander23 <- data2023 %>% filter (spp_name_lt=="Starkis") %>% drop_na(age_scales2)

# Count the number of observations for each age pair
count_df <- sander23 %>%
  count(age_scales2, age_scales) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_scales2 <- as.numeric(as.character(count_df$age_scales2))
count_df$age_scales <- as.numeric(as.character(count_df$age_scales))

ggplot(count_df, aes(x = age_scales2, y = age_scales, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Audrius)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()
```

# bream

```{r}
bream23 <- data2023 %>% filter (spp_name_lt=="Karsis") %>% drop_na(age_Egle)

# Count the number of observations for each age pair
count_df <- bream23 %>%
  count(age_Egle, age_Elyza) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_Egle <- as.numeric(as.character(count_df$age_Egle))
count_df$age_Elyza <- as.numeric(as.character(count_df$age_Elyza))

ggplot(count_df, aes(x = age_Egle, y = age_Elyza, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Egle)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()

# Scales
bream23 <- data2023 %>% filter (spp_name_lt=="Karsis") %>% drop_na(age_scales2)

# Count the number of observations for each age pair
count_df <- bream23 %>%
  count(age_scales2, age_scales) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_scales2 <- as.numeric(as.character(count_df$age_scales2))
count_df$age_scales <- as.numeric(as.character(count_df$age_scales))

ggplot(count_df, aes(x = age_scales2, y = age_scales, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Audrius)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()
```

# roach

```{r}
roach23 <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% drop_na(age_Egle)

# Count the number of observations for each age pair
count_df <- roach23 %>%
  count(age_Egle, age_Elyza) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_Egle <- as.numeric(as.character(count_df$age_Egle))
count_df$age_Elyza <- as.numeric(as.character(count_df$age_Elyza))

ggplot(count_df, aes(x = age_Egle, y = age_Elyza, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Egle)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()

# Scales
roach23 <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% drop_na(age_scales2)

# Count the number of observations for each age pair
count_df <- roach23 %>%
  count(age_scales2, age_scales) %>%
  filter(n > 0)

# Convert to numeric
count_df$age_scales2 <- as.numeric(as.character(count_df$age_scales2))
count_df$age_scales <- as.numeric(as.character(count_df$age_scales))

ggplot(count_df, aes(x = age_scales2, y = age_scales, label = n)) +
  geom_text(size = 4) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Comparison of Age Estimates with Counts",
    x = "Age estimate by Reader 1 (Audrius)",
    y = "Age estimate by Reader 2 (Elyza)"
  ) +
  theme_minimal()
```


#### REVISION

### Perch

# perch otoliths
```{r}
data2023 <- read_csv(file = "2023.csv")

perch23otoliths <- data2023 %>% filter (spp_name_lt=="Eserys") %>% select(Length = total_length, Age = age_Egle, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
perch23otoliths <- as.data.frame(perch23otoliths)
colSums(is.na(perch23otoliths))
table(perch23otoliths$Age)

min(perch23otoliths$Length)
max(perch23otoliths$Length)
mean(perch23otoliths$Length)
```

Priors - got from my article 1987-2023
```{r}
## Biological info - lengths in mm
max_size <- 355
max_size_se <- 17
birth_size <- 0
birth_size_se <- 0.001 #  cannot be zero
```

Model comparisons 
```{r}
LooicP <- Compare_Growth_Models(data = perch23otoliths,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)
# let's check which model is the best one
LooicP
```
VB  model is the best model

Perch otoliths model
```{r}
# Use the function to estimate the rstan model
MCMC_perchO <- Estimate_MCMC_Growth(perch23otoliths, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,  # minimum of 3 chains recommended
                                             BurnIn = 1000, # default is 10% of iterations
                                             thin = 10,      # a thinning rate of 10 is applied to overcome autocorrelation
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

library(rstan)
summary(MCMC_perchO, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_perchO, max.level = 2)

```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_perchO, pars = c("Linf", "k", "L0", "sigma"))
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode.

Convergence can also be checked using a Gelman Rubin test. If all point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2 then convergence has been reached. Ideally these should be close to one. If not, then the number of iterations should be increased. 
```{r}
rhats <- rhat(MCMC_perchO, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```

Autocorrelation
```{r}
mcmc_acf(MCMC_perchO, pars = c("Linf", "k", "L0", "sigma"))
```
This plot shows the autocorrelation lag that occurs in the MCMC model for each parameter. If each parameter has an autocorrelation value of zero at the end of the lag series, then no autocorrelation has occurred.

```{r}
params_PO <- Get_MCMC_parameters(MCMC_perchO)

# Return a growth curve with 50th and 95th percentiles
growth_perchO <- Calculate_MCMC_growth_curve(obj = MCMC_perchO, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))
library(tidybayes)
library(ggplot2)

ggplot(growth_perchO, aes(Age, LAA))+
  geom_point(data = perch23otoliths, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,13,1))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

# perch scales
Perch growth model using scales
```{r}
perch23scales <- data2023 %>% filter (spp_name_lt=="Eserys") %>% select(Length = total_length, Age = age_scales, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
perch23scales <- as.data.frame(perch23scales)
colSums(is.na(perch23scales))
table(perch23scales$Age)

min(perch23scales$Length)
max(perch23scales$Length)
mean(perch23scales$Length)
```

Model comparisons
```{r}
LooicP2 <- Compare_Growth_Models(data = perch23scales,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicP2
```

VB model is the best model, I am using it further
```{r}
# Use the function to estimate the rstan model
MCMC_perchS <- Estimate_MCMC_Growth(perch23scales, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10,
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_perchS, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_perchS, max.level = 2)
```

```{r}
mcmc_combo(MCMC_perchS, pars = c("Linf", "k", "L0", "sigma")) 
```

```{r}
rhats <- rhat(MCMC_perchS, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```

```{r}
mcmc_acf(MCMC_perchS, pars = c("Linf", "k", "L0", "sigma"))
```

```{r}
params_PS <- Get_MCMC_parameters(MCMC_perchS)

# Return a growth curve with 50th and 95th percentiles
growth_perchS <- Calculate_MCMC_growth_curve(obj = MCMC_perchS, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))
ggplot(growth_perchS, aes(Age, LAA)) +
  geom_point(data = perch23scales, aes(Age, Length), alpha = .3) +
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)") +
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0), breaks = seq(0,15,1)) +
  theme_bw() +
  theme(text = element_text(size = 14))
```


Both growth curves on one plot

```{r}
paramsPS_filtered <- params_PS %>% filter(Parameter %in% c("Linf", "K"))
paramsPO_filtered <- params_PO %>% filter(Parameter %in% c("Linf", "K"))

label_PS <- paste0("Scales:\n",
                   "L∞ = ", round(params_PS$mean[params_PS$Parameter == "Linf"]/10, 2), " ± ",
                   round(params_PS$se_mean[params_PS$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_PS$mean[params_PS$Parameter == "k"], 2), " ± ",
                   round(params_PS$se_mean[params_PS$Parameter == "k"], 2))

label_PO <- paste0("Otoliths:\n",
                   "L∞ = ", round(params_PO$mean[params_PO$Parameter == "Linf"]/10, 2), " ± ",
                   round(params_PO$se_mean[params_PO$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_PO$mean[params_PO$Parameter == "k"], 2), " ± ",
                   round(params_PO$se_mean[params_PO$Parameter == "k"], 2))

```


```{r}
# Convert growth curves from mm to cm
growth_perchS$LAA <- growth_perchS$LAA / 10
growth_perchS$.lower <- growth_perchS$.lower / 10
growth_perchS$.upper <- growth_perchS$.upper / 10

growth_perchO$LAA <- growth_perchO$LAA / 10
growth_perchO$.lower <- growth_perchO$.lower / 10
growth_perchO$.upper <- growth_perchO$.upper / 10

# Convert raw data from mm to cm
perch23scales$Length <- perch23scales$Length / 10
perch23otoliths$Length <- perch23otoliths$Length / 10


# Tag each growth curve with a label
growth_perchS$Source <- "Scales"
growth_perchO$Source <- "Otoliths"

# Combine the two into one data frame
growth_both <- rbind(growth_perchS, growth_perchO)

# Combine raw data for points
perch23scales$Source <- "Scales"
perch23otoliths$Source <- "Otoliths"
raw_data <- rbind(perch23scales, perch23otoliths)

perch <- ggplot(growth_both, aes(x = Age, y = LAA)) +
  geom_point(data = raw_data, aes(x = Age, y = Length, color = Source), alpha = 0.3, inherit.aes = FALSE) +
  geom_lineribbon(aes(ymin = .lower, ymax = .upper, fill = Source, 
                      color = Source, group = interaction(Source, .width)), 
                  alpha = 0.3, linewidth = 0.8) +
  scale_fill_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_color_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 20, 5)) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    panel.grid = element_blank(),
    axis.title = element_blank(),          
    axis.text = element_text(size = 16),  
    axis.ticks = element_line(),          
    legend.position = "none",               
    plot.title = element_text(face = "italic", size = 16)
  ) +
  labs(title = "c, Perca fluviatilis")

PERCH <- perch +
  annotate("text", x = 13, y = 15, label = label_PS, hjust = 0, size = 5, color = "#D55E00") +
  annotate("text", x = 13, y = 6, label = label_PO, hjust = 0, size = 5, color = "#332288")
```


## Pikeperch

# otoliths

```{r}
sander23otoliths <- data2023 %>% filter (spp_name_lt=="Starkis") %>% select(Length = total_length, Age = age_Egle, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
sander23otoliths <- as.data.frame(sander23otoliths)
colSums(is.na(sander23otoliths))
table(sander23otoliths$Age)

min(sander23otoliths$Length)
max(sander23otoliths$Length)
mean(sander23otoliths$Length)
```

Priors - got from my article (Pilipaityte et al. 2025) averaged between both periods
```{r}
## Biological info - lengths in mm
max_size <- 1055
max_size_se <- 492
birth_size <- 0
birth_size_se <- 0.001 #  cannot be zero
```
The model is highly sensitive to the choice of priors; increasing the maximum size and/or se improves convergence.

Model comparisons 
```{r}
LooicS1 <- Compare_Growth_Models(data = sander23otoliths,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicS1
```
VB  model is the best model

```{r}
# Use the function to estimate the rstan model
MCMC_sanderO <- Estimate_MCMC_Growth(sander23otoliths, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10, 
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_sanderO, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_sanderO, max.level = 2)
```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_sanderO, pars = c("Linf", "k", "L0", "sigma")) 
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode.

Convergence checked using a Gelman Rubin test
```{r}
rhats <- rhat(MCMC_sanderO, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```
All point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2 showing that convergence has been reached.

Autocorrelation
```{r}
mcmc_acf(MCMC_sanderO, pars = c("Linf", "k", "L0", "sigma"))
```
Each parameter has an autocorrelation value of zero at the end of the lag series showing that no autocorrelation has occurred.

Plot
```{r}
params_SO <- Get_MCMC_parameters(MCMC_sanderO)

# Return a growth curve with 50th and 95th percentiles
growth_sanderO <- Calculate_MCMC_growth_curve(obj = MCMC_sanderO, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))

library(tidybayes)
library(ggplot2)

ggplot(growth_sanderO, aes(Age, LAA))+
  geom_point(data = sander23otoliths, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,20,5))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

# pikeperch scales

```{r}
sander23scales <- data2023 %>% filter (spp_name_lt=="Starkis") %>% select(Length = total_length, Age = age_scales, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
sander23scales <- as.data.frame(sander23scales)
colSums(is.na(sander23scales))
table(sander23scales$Age)

min(sander23scales$Length)
max(sander23scales$Length)
mean(sander23scales$Length)
```

Model comparisons 
```{r}
LooicS2 <- Compare_Growth_Models(data = sander23scales,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicS2
```
VB  model is the best model

```{r}
# Use the function to estimate the rstan model
MCMC_sanderS <- Estimate_MCMC_Growth(sander23scales, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10, 
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_sanderS, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_sanderS, max.level = 2)
```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_sanderS, pars = c("Linf", "k", "L0", "sigma")) 
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode.

Convergence check using a Gelman Rubin test
```{r}
rhats <- rhat(MCMC_sanderS, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```
All point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2 - convergence has been reached.

Autocorrelation
```{r}
mcmc_acf(MCMC_sanderS, pars = c("Linf", "k", "L0", "sigma"))
```
Each parameter has an autocorrelation value of zero at the end of the lag series showing that no autocorrelation has occurred.

Plot
```{r}
params_SS <- Get_MCMC_parameters(MCMC_sanderS)

# Return a growth curve with 50th and 95th percentiles
growth_sanderS <- Calculate_MCMC_growth_curve(obj = MCMC_sanderS, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))

library(tidybayes)
library(ggplot2)

ggplot(growth_sanderS, aes(Age, LAA))+
  geom_point(data = sander23scales, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,20,5))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

```{r}
label_SS <- paste0("Scales:\n",
                   "L∞ = ", round(params_SS$mean[params_SS$Parameter == "Linf"]/10, 2), " ± ", round(params_SS$se_mean[params_SS$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_SS$mean[params_SS$Parameter == "k"], 2), " ± ", round(params_SS$se_mean[params_SS$Parameter == "k"], 2))

label_SO <- paste0("Otoliths:\n",
                   "L∞ = ", round(params_SO$mean[params_SO$Parameter == "Linf"]/10, 2), " ± ", round(params_SO$se_mean[params_SO$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_SO$mean[params_SO$Parameter == "k"], 2), " ± ", round(params_SO$se_mean[params_SO$Parameter == "k"], 2))
```

Plot showing both growth curves with scales and otoliths
```{r}
# Convert growth curves from mm to cm
growth_sanderS$LAA <- growth_sanderS$LAA / 10
growth_sanderS$.lower <- growth_sanderS$.lower / 10
growth_sanderS$.upper <- growth_sanderS$.upper / 10

growth_sanderO$LAA <- growth_sanderO$LAA / 10
growth_sanderO$.lower <- growth_sanderO$.lower / 10
growth_sanderO$.upper <- growth_sanderO$.upper / 10

# Convert raw data from mm to cm
sander23scales$Length <- sander23scales$Length / 10
sander23otoliths$Length <- sander23otoliths$Length / 10


# Tag each growth curve with a label
growth_sanderS$Source <- "Scales"
growth_sanderO$Source <- "Otoliths"

# Combine the two into one data frame
growth_both <- rbind(growth_sanderS, growth_sanderO)

# Combine raw data for points
sander23scales$Source <- "Scales"
sander23otoliths$Source <- "Otoliths"
raw_data <- rbind(sander23scales, sander23otoliths)

pikeperch <- ggplot(growth_both, aes(x = Age, y = LAA)) +
  geom_point(data = raw_data, aes(x = Age, y = Length, color = Source), alpha = 0.3, inherit.aes = FALSE) +
  geom_lineribbon(aes(ymin = .lower, ymax = .upper, fill = Source, 
                      color = Source, group = interaction(Source, .width)), 
                  alpha = 0.3, linewidth = 0.8) +
  scale_fill_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_color_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 20, 5)) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    panel.grid = element_blank(),
    axis.title = element_blank(),          
    axis.text = element_text(size = 16),  
    axis.ticks = element_line(),          
    legend.position = "none",               
    plot.title = element_text(face = "italic", size = 16)
  ) +
  labs(title = "d, Sander lucioperca")

PIKEPERCH <- pikeperch +
  annotate("text", x = 13, y = 29, label = label_SS, hjust = 0, size = 5, color = "#D55E00") +
  annotate("text", x = 13, y = 12, label = label_SO, hjust = 0, size = 5, color = "#332288")
```


## Roach

# roach otoliths

```{r}
roach23otoliths <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(Length = total_length, Age = age_Egle, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
roach23otoliths <- as.data.frame(roach23otoliths)
colSums(is.na(roach23otoliths))
table(roach23otoliths$Age)

min(roach23otoliths$Length)
max(roach23otoliths$Length)
mean(roach23otoliths$Length)
```

Priors - got from Pilipaityte et al. 2025 averaged between two periods (1947-2023)
```{r}
## Biological info - lengths in mm
max_size <- 418
max_size_se <- 21
birth_size <- 0
birth_size_se <- 0.001 #  cannot be zero
```

Model comparations 
```{r}
LooicR1 <- Compare_Growth_Models(data = roach23otoliths,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicR1
```
VB  model is the best model

Perch otoliths model
```{r}
# Use the function to estimate the rstan model
MCMC_roachO <- Estimate_MCMC_Growth(roach23otoliths, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10, 
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_roachO, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_roachO, max.level = 2)
```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_roachO, pars = c("Linf", "k", "L0", "sigma")) 
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode.

Convergence check using a Gelman Rubin test
```{r}
rhats <- rhat(MCMC_roachO, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```
All point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2 - convergence has been reached.

Autocorrelation
```{r}
mcmc_acf(MCMC_roachO, pars = c("Linf", "k", "L0", "sigma"))
```
This plot shows the autocorrelation lag that occurs in the MCMC model for each parameter. Each parameter has an autocorrelation value of zero at the end of the lag series - no autocorrelation has occurred.

Plot
```{r}
params_RO <- Get_MCMC_parameters(MCMC_roachO)

# Return a growth curve with 50th and 95th percentiles
growth_roachO <- Calculate_MCMC_growth_curve(obj = MCMC_roachO, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))

library(tidybayes)
library(ggplot2)

ggplot(growth_roachO, aes(Age, LAA))+
  geom_point(data = roach23otoliths, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,20,5))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

# roach scales

```{r}
roach23scales <- data2023 %>% filter (spp_name_lt=="Kuoja") %>% select(Length = total_length, Age = age_scales, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
roach23scales <- as.data.frame(roach23scales)
colSums(is.na(roach23scales))
table(roach23scales$Age)

min(roach23scales$Length)
max(roach23scales$Length)
mean(roach23scales$Length)
```

Model comparisons 
```{r}
LooicR2 <- Compare_Growth_Models(data = roach23scales,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicR2
```
VB  model is the best model

```{r}
# Use the function to estimate the rstan model
MCMC_roachS <- Estimate_MCMC_Growth(roach23scales, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10, 
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_roachS, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_roachS, max.level = 2)
```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_roachS, pars = c("Linf", "k", "L0", "sigma")) 
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode, except L0 which is 0 truncated. 

Convergence check using a Gelman Rubin test
```{r}
rhats <- rhat(MCMC_roachS, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```
All point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2  - convergence has been reached.

Autocorrelation
```{r}
mcmc_acf(MCMC_roachS, pars = c("Linf", "k", "L0", "sigma"))
```
This plot shows the autocorrelation lag that occurs in the MCMC model for each parameter. Each parameter has an autocorrelation value of zero at the end of the lag series - no autocorrelation has occurred.

Plot
```{r}
params_RS <- Get_MCMC_parameters(MCMC_roachS)

# Return a growth curve with 50th and 95th percentiles
growth_roachS <- Calculate_MCMC_growth_curve(obj = MCMC_roachS, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))

library(tidybayes)
library(ggplot2)

ggplot(growth_roachS, aes(Age, LAA))+
  geom_point(data = roach23scales, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,20,5))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

```{r}
label_RS <- paste0("Scales:\n",
                   "L∞ = ", round(params_RS$mean[params_RS$Parameter == "Linf"]/10, 2), " ± ", round(params_RS$se_mean[params_RS$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_RS$mean[params_RS$Parameter == "k"], 2), " ± ", round(params_RS$se_mean[params_RS$Parameter == "k"], 2))

label_RO <- paste0("Otoliths:\n",
                   "L∞ = ", round(params_RO$mean[params_RO$Parameter == "Linf"]/10, 2), " ± ", round(params_RO$se_mean[params_RO$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_RO$mean[params_RO$Parameter == "k"], 2), " ± ", round(params_RO$se_mean[params_RO$Parameter == "k"], 2))
```

Roach plot with both curves
```{r}
# Convert growth curves from mm to cm
growth_roachS$LAA <- growth_roachS$LAA / 10
growth_roachS$.lower <- growth_roachS$.lower / 10
growth_roachS$.upper <- growth_roachS$.upper / 10

growth_roachO$LAA <- growth_roachO$LAA / 10
growth_roachO$.lower <- growth_roachO$.lower / 10
growth_roachO$.upper <- growth_roachO$.upper / 10

# Convert raw data from mm to cm
roach23scales$Length <- roach23scales$Length / 10
roach23otoliths$Length <- roach23otoliths$Length / 10


# Tag each growth curve with a label
growth_roachS$Source <- "Scales"
growth_roachO$Source <- "Otoliths"

# Combine the two into one data frame
growth_both <- rbind(growth_roachS, growth_roachO)

# Combine raw data for points
roach23scales$Source <- "Scales"
roach23otoliths$Source <- "Otoliths"
raw_data <- rbind(roach23scales, roach23otoliths)

roach <- ggplot(growth_both, aes(x = Age, y = LAA)) +
  geom_point(data = raw_data, aes(x = Age, y = Length, color = Source), alpha = 0.3, inherit.aes = FALSE) +
  geom_lineribbon(aes(ymin = .lower, ymax = .upper, fill = Source, 
                      color = Source, group = interaction(Source, .width)), 
                  alpha = 0.3, linewidth = 0.8) +
  scale_fill_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_color_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 20, 5)) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    panel.grid = element_blank(),
    axis.title = element_blank(),          
    axis.text = element_text(size = 16),  
    axis.ticks = element_line(),          
    legend.position = "none",               
    plot.title = element_text(face = "italic", size = 16)
  ) +
  labs(title = "b, Rutilus rutilus")

ROACH <- roach +
  annotate("text", x = 13, y = 15, label = label_RS, hjust = 0, size = 5, color = "#D55E00") +
  annotate("text", x = 13, y = 6, label = label_RO, hjust = 0, size = 5, color = "#332288")
```


## Bream

# bream otoliths

```{r}
bream23otoliths <- data2023 %>% filter (spp_name_lt=="Karsis") %>% select(Length = total_length, Age = age_Egle, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
bream23otoliths <- as.data.frame(bream23otoliths)
colSums(is.na(bream23otoliths))
table(bream23otoliths$Age)

min(bream23otoliths$Length)
max(bream23otoliths$Length)
mean(bream23otoliths$Length)
```

Priors - got from Pilipaityte et. al (2025) averaged between two periods (1947-2023)
```{r}
## Biological info - lengths in mm
max_size <- 570
max_size_se <- 24
birth_size <- 0
birth_size_se <- 0.001 #  cannot be zero
```
The model is highly sensitive to the choice of priors; increasing the maximum size and/or se improves convergence.

Model comparisons 
```{r}
LooicB1 <- Compare_Growth_Models(data = bream23otoliths,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicB1
```
VB  model is the best model

```{r}
# Use the function to estimate the rstan model
MCMC_breamO <- Estimate_MCMC_Growth(bream23otoliths, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10, 
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_breamO, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_breamO, max.level = 2)
```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_breamO, pars = c("Linf", "k", "L0", "sigma")) 
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode.

Convergence check using a Gelman Rubin test 
```{r}
rhats <- rhat(MCMC_breamO, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```
All point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2 - convergence has been reached. 

Autocorrelation
```{r}
mcmc_acf(MCMC_breamO, pars = c("Linf", "k", "L0", "sigma"))
```
All parameters have an autocorrelation value of zero at the end of the lag series - no autocorrelation has occurred.

Plot
```{r}
params_BO <- Get_MCMC_parameters(MCMC_breamO)

# Return a growth curve with 50th and 95th percentiles
growth_breamO <- Calculate_MCMC_growth_curve(obj = MCMC_breamO, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))

library(tidybayes)
library(ggplot2)

ggplot(growth_breamO, aes(Age, LAA))+
  geom_point(data = bream23otoliths, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,20,5))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

# bream scales

```{r}
bream23scales <- data2023 %>% filter (spp_name_lt=="Karsis") %>% select(Length = total_length, Age = age_scales, sex_en) %>% drop_na(Age) %>% mutate(Length = Length * 10)
```

```{r}
bream23scales <- as.data.frame(bream23scales)
colSums(is.na(bream23scales))
table(bream23scales$Age)

min(bream23scales$Length)
max(bream23scales$Length)
mean(bream23scales$Length)
```

Model comparisons 
```{r}
LooicB2 <- Compare_Growth_Models(data = bream23scales,
                                               stats = "LooIC",
                                               iter = 10000, 
                                               n_cores = 3,
                                               n.chains = 4,
                                               BurnIn = 1000,
                                               thin = 1, 
                                               Linf = max_size,
                                               Linf.se = max_size_se,
                                               L0 = birth_size,
                                               L0.se = birth_size_se,
                                               verbose = TRUE,
                                               sigma.max = 100,
                                               k.max = 1)

LooicB2
```
VB  model is the best model

```{r}
# Use the function to estimate the rstan model
MCMC_breamS <- Estimate_MCMC_Growth(bream23scales, 
                                             Model = "VB" ,
                                             iter = 10000, 
                                             n.chains = 4,
                                             BurnIn = 1000,
                                             thin = 10, 
                                             Linf = max_size,
                                             Linf.se = max_size_se,
                                             L0 = birth_size,
                                             L0.se = birth_size_se,
                                             sigma.max = 100,
                                             verbose = TRUE,
                                             k.max = 1)

summary(MCMC_breamS, pars = c("Linf", "k", "L0", "sigma"))$summary
str(MCMC_breamS, max.level = 2)
```

Chain convergence
```{r}
library(bayesplot)
mcmc_combo(MCMC_breamS, pars = c("Linf", "k", "L0", "sigma")) 
```
This plot shows good model convergence. All of the chains overlap and each of the parameters has the correct posterior distribution with a single mode.

Convergence check using a Gelman Rubin test 
```{r}
rhats <- rhat(MCMC_breamS, pars = c("Linf", "k", "L0", "sigma"))
mcmc_rhat(rhats)
```
All point estimates of the Gelman-Rubin diagnostic (R^) for each parameter are less than 1.2 - convergence has been reached.

Autocorrelation
```{r}
mcmc_acf(MCMC_breamS, pars = c("Linf", "k", "L0", "sigma"))
```
This plot shows the autocorrelation lag for each parameter in the MCMC model. All parameters reach an autocorrelation value of zero by the end of the lag series, indicating that no significant autocorrelation remains.

Plot
```{r}
params_BS <- Get_MCMC_parameters(MCMC_breamS)

# Return a growth curve with 50th and 95th percentiles
growth_breamS <- Calculate_MCMC_growth_curve(obj = MCMC_breamS, Model = "VB",
                                            max.age = 25, probs = c(.5,.95))

library(tidybayes)
library(ggplot2)

ggplot(growth_breamS, aes(Age, LAA))+
  geom_point(data = bream23scales, aes(Age, Length), alpha = .3)+
geom_lineribbon(aes( ymin = .lower, ymax = .upper,
                       fill = factor(.width)), linewidth = .8) +  labs(y = "Total Length (mm)", x = "Age (yrs)")+
  scale_fill_brewer(palette="BuPu", direction=1,name =NULL)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0), breaks = seq(0,20,5))+
  theme_bw()+
  theme(text = element_text(size = 14))
```

```{r}
label_BS <- paste0("Scales:\n",
                   "L∞ = ", round(params_BS$mean[params_BS$Parameter == "Linf"]/10, 2), " ± ", round(params_BS$se_mean[params_BS$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_BS$mean[params_BS$Parameter == "k"], 2), " ± ", round(params_BS$se_mean[params_BS$Parameter == "k"], 2))

label_BO <- paste0("Otoliths:\n",
                   "L∞ = ", round(params_BO$mean[params_BO$Parameter == "Linf"]/10, 2), " ± ", round(params_BO$se_mean[params_BO$Parameter == "Linf"]/10, 2), " cm\n",
                   "K = ", round(params_BO$mean[params_BO$Parameter == "k"], 2), " ± ", round(params_BO$se_mean[params_BO$Parameter == "k"], 2))
```

Bream plot with both curves
```{r}
# Convert growth curves from mm to cm
growth_breamS$LAA <- growth_breamS$LAA / 10
growth_breamS$.lower <- growth_breamS$.lower / 10
growth_breamS$.upper <- growth_breamS$.upper / 10

growth_breamO$LAA <- growth_breamO$LAA / 10
growth_breamO$.lower <- growth_breamO$.lower / 10
growth_breamO$.upper <- growth_breamO$.upper / 10

# Convert raw data from mm to cm
bream23scales$Length <- bream23scales$Length / 10
bream23otoliths$Length <- bream23otoliths$Length / 10


# Tag each growth curve with a label
growth_breamS$Source <- "Scales"
growth_breamO$Source <- "Otoliths"

# Combine the two into one data frame
growth_both <- rbind(growth_breamS, growth_breamO)

# Combine raw data for points
bream23scales$Source <- "Scales"
bream23otoliths$Source <- "Otoliths"
raw_data <- rbind(bream23scales, bream23otoliths)

bream <- ggplot(growth_both, aes(x = Age, y = LAA)) +
  geom_point(data = raw_data, aes(x = Age, y = Length, color = Source), alpha = 0.3, inherit.aes = FALSE) +
  geom_lineribbon(aes(ymin = .lower, ymax = .upper, fill = Source, 
                      color = Source, group = interaction(Source, .width)), 
                  alpha = 0.3, linewidth = 0.8) +
  scale_fill_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_color_manual(name = NULL, values = c("Scales" = "#D55E00", "Otoliths" = "#332288")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 20, 5)) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    panel.grid = element_blank(),
    axis.title = element_blank(),          
    axis.text = element_text(size = 16),  
    axis.ticks = element_line(),          
    legend.position = "none",               
    plot.title = element_text(face = "italic", size = 16)
  ) +
  labs(title = "a, Abramis brama")

BREAM <- bream +
  annotate("text", x = 13, y = 22, label = label_BS, hjust = 0, size = 5, color = "#D55E00") +
  annotate("text", x = 13, y = 9, label = label_BO, hjust = 0, size = 5, color = "#332288")

```

# One plot for four species

```{r}
library(gridExtra)
library(grid)

# Arrange the 2x2 panel without titles
combined_plot <- grid.arrange(
  BREAM, ROACH, PERCH, PIKEPERCH,
  ncol = 2
)

# Add shared x and y axis labels
final_plot <- grid.arrange(
  combined_plot,
  bottom = textGrob("Age (yrs)", gp = gpar(fontsize = 16)),
  left = textGrob("Total Length (cm)", rot = 90, gp = gpar(fontsize = 16))
)

tiff("vb_bayes.tiff", width = 300, height = 250, units = "mm", res = 300, compression = "lzw")
grid.draw(final_plot)
dev.off()

```

